<?xml version="1.0" encoding="UTF-8"?>
<!--

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements. See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership. The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License. You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
    KIND, either express or implied. See the License for the
    specific language governing permissions and limitations
    under the License.

-->
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet author="fineract" id="9001-1">
        <createTable tableName="m_extend_client_credit_report">
            <column name="id" type="BIGSERIAL">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="client_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <!-- Report Metadata -->
            <column name="report_type" type="VARCHAR(20)">
                <constraints nullable="false"/>
            </column>
            <column name="report_status" type="VARCHAR(10)" defaultValue="PENDING">
                <constraints nullable="false"/>
            </column>
            <column name="credit_report_provider" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="provider_report_id" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>

            <!-- Basic Credit Information (primary score only, detailed scores in separate table) -->
            <column name="primary_credit_score" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="primary_credit_rating" type="VARCHAR(50)">
                <constraints nullable="true"/>
            </column>

            <!-- Customer Information (from API response) -->
            <column name="customer_name" type="VARCHAR(200)">
                <constraints nullable="true"/>
            </column>
            <column name="customer_pan" type="VARCHAR(10)">
                <constraints nullable="true"/>
            </column>
            <column name="customer_aadhaar" type="VARCHAR(12)">
                <constraints nullable="true"/>
            </column>
            <column name="customer_mobile" type="VARCHAR(15)">
                <constraints nullable="true"/>
            </column>
            <column name="customer_address" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="date_of_birth" type="DATE">
                <constraints nullable="true"/>
            </column>
            <column name="gender" type="VARCHAR(10)">
                <constraints nullable="true"/>
            </column>

            <!-- Credit Summary Information -->
            <column name="total_accounts" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="active_accounts" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="closed_accounts" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="overdue_accounts" type="INTEGER">
                <constraints nullable="true"/>
            </column>

            <!-- Financial Information -->
            <column name="total_credit_limit" type="DECIMAL(19,6)">
                <constraints nullable="true"/>
            </column>
            <column name="total_outstanding_amount" type="DECIMAL(19,6)">
                <constraints nullable="true"/>
            </column>
            <column name="total_overdue_amount" type="DECIMAL(19,6)">
                <constraints nullable="true"/>
            </column>
            <column name="highest_credit_amount" type="DECIMAL(19,6)">
                <constraints nullable="true"/>
            </column>

            <!-- Credit Report Summary (detailed scores moved to separate table) -->
            <column name="total_score_models" type="INTEGER" defaultValue="0">
                <constraints nullable="true"/>
            </column>

            <!-- Delinquency Information -->
            <column name="days_past_due" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="worst_status_12_months" type="VARCHAR(20)">
                <constraints nullable="true"/>
            </column>
            <column name="worst_status_24_months" type="VARCHAR(20)">
                <constraints nullable="true"/>
            </column>

            <!-- Enquiry Information -->
            <column name="enquiries_last_30_days" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="enquiries_last_90_days" type="INTEGER">
                <constraints nullable="true"/>
            </column>
            <column name="enquiries_last_12_months" type="INTEGER">
                <constraints nullable="true"/>
            </column>

            <!-- Report Metadata -->
            <column name="report_generated_on" type="DATE">
                <constraints nullable="true"/>
            </column>
            <column name="requested_on" type="TIMESTAMP WITH TIME ZONE">
                <constraints nullable="true"/>
            </column>
            <column name="requested_by_user_id" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="report_summary" type="TEXT">
                <constraints nullable="true"/>
            </column>
            <column name="report_notes" type="TEXT">
                <constraints nullable="true"/>
            </column>

            <!-- Error Information -->
            <column name="error_code" type="VARCHAR(100)">
                <constraints nullable="true"/>
            </column>
            <column name="error_message" type="TEXT">
                <constraints nullable="true"/>
            </column>

            <!-- Raw provider response for audit and debugging purposes -->
            <column name="raw_provider_response" type="JSONB">
                <constraints nullable="true"/>
            </column>

            <!-- Additional data field for manual entry and supplemental information -->
            <column name="additional_data" type="JSONB">
                <constraints nullable="true"/>
            </column>

            <!-- Audit fields -->
            <column name="created_on_utc" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="BIGINT">
                <constraints nullable="true"/>
            </column>
            <column name="last_modified_on_utc" type="TIMESTAMP WITH TIME ZONE" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="last_modified_by" type="BIGINT">
                <constraints nullable="true"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="fineract" id="9001-2">
        <!-- Add foreign key constraints -->
        <addForeignKeyConstraint baseTableName="m_extend_client_credit_report"
                                 baseColumnNames="client_id"
                                 constraintName="FK_extend_credit_report_client"
                                 referencedTableName="m_client"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="m_extend_client_credit_report"
                                 baseColumnNames="requested_by_user_id"
                                 constraintName="FK_extend_credit_report_requested_by_user"
                                 referencedTableName="m_appuser"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="m_extend_client_credit_report"
                                 baseColumnNames="created_by"
                                 constraintName="FK_extend_credit_report_created_by_user"
                                 referencedTableName="m_appuser"
                                 referencedColumnNames="id"/>

        <addForeignKeyConstraint baseTableName="m_extend_client_credit_report"
                                 baseColumnNames="last_modified_by"
                                 constraintName="FK_extend_credit_report_modified_by_user"
                                 referencedTableName="m_appuser"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet author="fineract" id="9001-3">
        <!-- Add performance indexes for frequently queried fields -->
        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_client_id">
            <column name="client_id"/>
        </createIndex>

        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_status">
            <column name="report_status"/>
        </createIndex>

        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_primary_score">
            <column name="primary_credit_score"/>
        </createIndex>

        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_customer_pan">
            <column name="customer_pan"/>
        </createIndex>

        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_customer_aadhaar">
            <column name="customer_aadhaar"/>
        </createIndex>

        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_provider">
            <column name="credit_report_provider"/>
        </createIndex>

        <createIndex tableName="m_extend_client_credit_report" indexName="idx_extend_credit_report_generated_on">
            <column name="report_generated_on"/>
        </createIndex>

        <!-- PostgreSQL-specific GIN indexes for JSONB -->
        <sql>CREATE INDEX idx_extend_credit_report_raw_response_gin ON m_extend_client_credit_report USING GIN (raw_provider_response);</sql>
        <sql>CREATE INDEX idx_extend_credit_report_additional_data_gin ON m_extend_client_credit_report USING GIN (additional_data);</sql>
    </changeSet>

    <!-- Add CLIENT_CREDIT_REPORT permissions -->
    <changeSet author="fineract" id="9001-4">
        <insert tableName="m_permission">
            <column name="grouping" value="Custom"/>
            <column name="code" value="READ_CLIENT_CREDIT_REPORT"/>
            <column name="entity_name" value="CLIENT_CREDIT_REPORT"/>
            <column name="action_name" value="READ"/>
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
        <insert tableName="m_permission">
            <column name="grouping" value="Custom"/>
            <column name="code" value="CREATE_CLIENT_CREDIT_REPORT"/>
            <column name="entity_name" value="CLIENT_CREDIT_REPORT"/>
            <column name="action_name" value="CREATE"/>
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
        <insert tableName="m_permission">
            <column name="grouping" value="Custom"/>
            <column name="code" value="UPDATE_CLIENT_CREDIT_REPORT"/>
            <column name="entity_name" value="CLIENT_CREDIT_REPORT"/>
            <column name="action_name" value="UPDATE"/>
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
        <insert tableName="m_permission">
            <column name="grouping" value="Custom"/>
            <column name="code" value="DELETE_CLIENT_CREDIT_REPORT"/>
            <column name="entity_name" value="CLIENT_CREDIT_REPORT"/>
            <column name="action_name" value="DELETE"/>
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
        <insert tableName="m_permission">
            <column name="grouping" value="Custom"/>
            <column name="code" value="PULL_CLIENT_CREDIT_REPORT"/>
            <column name="entity_name" value="CLIENT_CREDIT_REPORT"/>
            <column name="action_name" value="PULL"/>
            <column name="can_maker_checker" valueBoolean="false"/>
        </insert>
    </changeSet>
</databaseChangeLog>
